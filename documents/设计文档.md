# 角色管理系统（Kyarakuta）设计文档

## 项目概述

Kyarakuta 是一个专为作家、剧本创作者和小说家设计的角色管理系统，用于管理创作过程中的各种元素，如章节、事件、角色等。系统集成了 AI 功能，提供角色对话和内容一致性分析能力，帮助创作者打造更加连贯、丰富的故事世界。

## 功能需求

### 1. 核心 CRUD 功能

- **作品管理**：创建、查看、编辑和删除作品
- **章节管理**：按顺序组织故事章节
- **事件管理**：记录故事中的重要事件
- **角色管理**：创建和管理故事角色
- **角色关系管理**：定义角色之间的关系
- **世界观管理**：记录和组织故事的世界观设定
- **时间线管理**：按时间顺序组织事件

### 2. AI 功能

- **角色对话**：基于角色设定生成对话，帮助作者理解和深化角色性格
- **章节一致性分析**：检查章节是否与世界观设定和前后章节内容保持一致

### 3. 用户体验

- **自定义属性**：每个作品可以自定义数据结构和属性
- **可视化界面**：通过 Windows UI 提供直观的操作界面
- **实时反馈**：AI 分析结果实时展示

## 技术栈

- **前端**：Next.js、React、TailwindCSS
- **后端**：Supabase（身份验证、数据库、存储）
- **ORM**：Drizzle
- **AI**：Vercel AI SDK、OpenAI API
- **包管理器**：Bun

## 数据模型

已经在 schema.ts 中定义了以下数据表：

1. **works**：作品表
2. **chapters**：章节表
3. **events**：事件表
4. **characters**：角色表
5. **characterRelations**：角色关系表
6. **worldviews**：世界观信息表
7. **timelines**：时间线表
8. **aiAnalyses**：AI 分析记录表

## 架构设计

### 前端架构

- **组件结构**：

  - `/app/components/windows`：主要界面组件
  - `/app/components/ui`：通用 UI 组件
  - `/app/components/forms`：表单组件

- **状态管理**：使用 React 状态和上下文管理应用状态

### 后端架构

- **数据访问层**：Drizzle ORM 提供数据库访问
- **API 层**：Next.js API 路由处理请求
- **AI 服务层**：Vercel AI SDK 集成 OpenAI

### 集成点

- **Supabase 集成**：身份验证、数据存储
- **OpenAI 集成**：角色对话和章节分析

## UI/UX 设计原则

- **简洁明了**：界面简洁，突出内容
- **逻辑分组**：相关功能组织在一起，提高可读性
- **一致性**：UI 元素和交互模式保持一致
- **响应式**：适应不同设备和屏幕尺寸

## 开发规范

- **代码组织**：

  - 使用 @ 别名路径
  - 使用 TailwindCSS 进行样式设计
  - 逻辑分组提高可读性
  - 提取自定义 hooks 复用逻辑
  - 组件拆分组织 UI 层次
  - 使用内联函数减少代码噪音

- **注释规范**：代码中添加必要的注释，解释复杂逻辑和组件用途

## 安全考虑

- **身份验证**：使用 Supabase 提供的身份验证机制
- **数据访问控制**：确保用户只能访问自己的数据
- **API 安全**：保护 AI API 密钥，实施请求限制

# 窗口管理系统设计文档

## 概述

本系统使用 React 和 98.css 构建了一个 Windows 98 风格的桌面环境，用于角色管理和故事创作。主要功能包括创建和管理窗口、处理窗口交互以及维护窗口状态。

## 窗口交互设计

### 1. 窗口操作

- **双击打开**: 通过双击桌面图标打开窗口，而非单击
- **窗口唯一性**: 每种类型的窗口只能打开一个实例
- **z-index 管理**: 点击窗口时将其置于最顶层
- **窗口移动**: 通过拖拽标题栏移动窗口
- **窗口大小调整**: 支持八个方向的大小调整
- **最小化/最大化/关闭**: 支持基本窗口操作按钮功能

### 2. 实现细节

#### 窗口打开与唯一性

- 使用 `openWindows` 状态数组管理当前打开的窗口
- 在 `handleOpen` 函数中检查窗口类型是否已存在
- 如果已存在，将该窗口重新置顶
- 使用 `onDoubleClick` 事件触发窗口打开

#### Z-Index 管理

- 使用全局计数器 `globalZIndexCounter` 跟踪当前最高 z-index
- 为每个窗口分配初始 z-index 值
- 点击窗口或标题栏时，增加全局计数器并更新窗口的 z-index

## 技术实现

### 1. 组件结构

- **Window98.tsx**: 核心窗口组件，处理所有窗口相关操作
- **page.tsx**: 主页面，管理桌面图标和窗口状态

### 2. 关键状态管理

```typescript
// 窗口列表管理
const [openWindows, setOpenWindows] = useState<{ type: string; id: number }[]>(
	[]
);

// 窗口 z-index 管理
let globalZIndexCounter = 1000;
const [zIndex, setZIndex] = useState(globalZIndexCounter);
```

### 3. 关键函数

- **handleOpen**: 处理窗口打开逻辑，确保唯一性
- **bringToFront**: 更新窗口 z-index 使其置顶
- **onMouseDown**: 处理窗口拖动开始和置顶
- **handleWindowClick**: 处理窗口点击置顶

## 未来改进

- 实现窗口状态持久化
- 添加窗口组最小化到任务栏功能
- 增强窗口间数据交互能力
- 实现窗口聚焦状态视觉反馈
